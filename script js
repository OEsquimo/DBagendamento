/*
 * Arquivo: script.js
 * Descrição: Lógica principal para a interface de agendamento do cliente.
 * Versão: 3.3 (Fluxo de agendamento com orçamento na segunda etapa)
 */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// ==========================================================================
// 1. CONFIGURAÇÃO E VARIÁVEIS GLOBAIS
// ==========================================================================

// Configuração do Firebase - Substitua pelos seus dados
const firebaseConfig = {
    apiKey: "AIzaSyCFf5gckKE6rg7MFuBYAO84aV-sNrdY2JQ",
    authDomain: "agendamento-esquimo.firebaseapp.com",
    databaseURL: "https://agendamento-esquimo-default-rtdb.firebaseio.com",
    projectId: "agendamento-esquimo",
    storageBucket: "agendamento-esquimo.firebasestorage.app",
    messagingSenderId: "348946727206",
    appId: "1:348946727206:web:f5989788f13c259be0c1e7",
    measurementId: "G-Z0EMQ3XQ1D"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

// Variáveis de estado
let servicosDisponiveis = {};
let servicosSelecionados = [];
let configuracoes = {};

// Elementos HTML das seções
const servicosSection = document.getElementById('servicosSection');
const camposAdicionaisSection = document.getElementById('camposAdicionaisSection');
const dadosPessoaisSection = document.getElementById('dadosPessoaisSection');

// Elementos HTML dos formulários e botões
const formServicos = document.getElementById('formServicos');
const servicosList = document.getElementById('servicosList');
const btnContinuar = document.getElementById('btnContinuar');

const formCamposAdicionais = document.getElementById('formCamposAdicionais');
const camposAdicionaisList = document.getElementById('camposAdicionaisList');
const summaryServicosList = document.getElementById('summaryServicosList');
const totalPriceElement = document.getElementById('totalPrice');
const btnVoltarCampos = document.getElementById('btnVoltarCampos');

const formDadosAgendamento = document.getElementById('formDadosAgendamento');
const dataInput = document.getElementById('data');
const horaSelect = document.getElementById('hora');
const btnVoltarDados = document.getElementById('btnVoltarDados');
const btnFinalizar = document.getElementById('btnFinalizar');
const orcamentoTotalInput = document.getElementById('orcamentoTotal');

const loadingMessage = document.getElementById('loadingMessage');
const successMessage = document.getElementById('successMessage');
const errorMessage = document.getElementById('errorMessage');

// ==========================================================================
// 2. FUNÇÕES DE INICIALIZAÇÃO
// ==========================================================================

document.addEventListener('DOMContentLoaded', async () => {
    try {
        await loadConfig();
        await loadServicos();
        setupEventListeners();
    } catch (error) {
        console.error("Erro ao inicializar a aplicação:", error);
        showError('Não foi possível carregar os dados. Tente novamente mais tarde.');
    }
});

async function loadConfig() {
    const configRef = ref(database, 'configuracoes');
    const snapshot = await get(configRef);
    if (snapshot.exists()) {
        configuracoes = snapshot.val();
    } else {
        throw new Error("Configurações não encontradas.");
    }
}

async function loadServicos() {
    const servicosRef = ref(database, 'servicos');
    const snapshot = await get(servicosRef);
    if (snapshot.exists()) {
        servicosDisponiveis = snapshot.val();
        renderServicos();
    } else {
        showError('Nenhum serviço disponível no momento.');
    }
}

function setupEventListeners() {
    btnContinuar.addEventListener('click', () => {
        servicosSection.classList.add('hidden');
        renderCamposAdicionaisForm();
        camposAdicionaisSection.classList.remove('hidden');
    });

    btnVoltarCampos.addEventListener('click', () => {
        camposAdicionaisSection.classList.add('hidden');
        servicosSection.classList.remove('hidden');
    });

    formCamposAdicionais.addEventListener('submit', (e) => {
        e.preventDefault();
        camposAdicionaisSection.classList.add('hidden');
        dadosPessoaisSection.classList.remove('hidden');
    });

    btnVoltarDados.addEventListener('click', () => {
        dadosPessoaisSection.classList.add('hidden');
        camposAdicionaisSection.classList.remove('hidden');
    });

    formDadosAgendamento.addEventListener('submit', handleFormSubmit);
    dataInput.addEventListener('change', updateHorarios);
    dataInput.min = new Date().toISOString().split('T')[0];
    horaSelect.addEventListener('change', () => btnFinalizar.disabled = !horaSelect.value);
}

// ==========================================================================
// 3. RENDERIZAÇÃO E ATUALIZAÇÃO DA UI
// ==========================================================================

function renderServicos() {
    servicosList.innerHTML = '';
    for (const key in servicosDisponiveis) {
        const servico = servicosDisponiveis[key];
        const isSelected = servicosSelecionados.some(s => s.id === key);
        const li = document.createElement('li');
        li.dataset.key = key;
        li.innerHTML = `
            <div>
                <h4>${servico.nome}</h4>
                <p>${servico.descricao}</p>
                <p><strong>Preço Base:</strong> R$ ${servico.precoBase.toFixed(2)}</p>
            </div>
            <button type="button" class="btn btn-primary btn-select-service" data-key="${key}" ${isSelected ? 'disabled' : ''}>
                ${isSelected ? 'Adicionado' : 'Selecionar'}
            </button>
        `;
        li.querySelector('.btn-select-service').addEventListener('click', (e) => {
            handleServiceSelection(e.target.dataset.key);
        });
        servicosList.appendChild(li);
    }
}

function handleServiceSelection(key) {
    if (!servicosSelecionados.find(s => s.id === key)) {
        const servico = { ...servicosDisponiveis[key], id: key };
        servicosSelecionados.push(servico);
        const btn = document.querySelector(`li[data-key="${key}"] .btn-select-service`);
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'Adicionado';
        }
    }
    btnContinuar.disabled = servicosSelecionados.length === 0;
}

function removeService(key) {
    servicosSelecionados = servicosSelecionados.filter(s => s.id !== key);
    const btn = document.querySelector(`li[data-key="${key}"] .btn-select-service`);
    if (btn) {
        btn.disabled = false;
        btn.textContent = 'Selecionar';
    }
    updateSummary();
    btnContinuar.disabled = servicosSelecionados.length === 0;
}

function renderCamposAdicionaisForm() {
    camposAdicionaisList.innerHTML = '';
    servicosSelecionados.forEach(servico => {
        if (servico.camposAdicionais && servico.camposAdicionais.length > 0) {
            const serviceDiv = document.createElement('div');
            serviceDiv.className = 'additional-service-form';
            serviceDiv.innerHTML = `<h3>${servico.nome}</h3>`;
            
            servico.camposAdicionais.forEach(campo => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                const label = document.createElement('label');
                label.textContent = campo.nome;
                formGroup.appendChild(label);

                if (campo.tipo === 'select') {
                    const select = document.createElement('select');
                    select.className = 'form-control additional-field-select';
                    select.dataset.serviceId = servico.id;
                    select.dataset.fieldName = campo.nome;
                    campo.opcoes.forEach(opcao => {
                        const [nomeOpcao, preco] = opcao.split(', R$');
                        const option = document.createElement('option');
                        option.value = preco ? parseFloat(preco.trim()) : 0;
                        option.textContent = nomeOpcao.trim();
                        select.appendChild(option);
                    });
                    select.addEventListener('change', updateSummary);
                    formGroup.appendChild(select);
                } else if (campo.tipo === 'text') {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'form-control additional-field-input';
                    input.dataset.serviceId = servico.id;
                    input.dataset.fieldName = campo.nome;
                    input.placeholder = 'Valor (R$)';
                    input.addEventListener('input', updateSummary);
                    formGroup.appendChild(input);
                }
                serviceDiv.appendChild(formGroup);
            });
            camposAdicionaisList.appendChild(serviceDiv);
        }
    });
    updateSummary();
}

function updateSummary() {
    summaryServicosList.innerHTML = '';
    let total = 0;

    servicosSelecionados.forEach(servico => {
        let precoServico = parseFloat(servico.precoBase);
        const camposAdicionaisSelecionados = {};

        document.querySelectorAll(`.additional-field-select[data-service-id="${servico.id}"]`).forEach(select => {
            const fieldName = select.dataset.fieldName;
            const value = parseFloat(select.value);
            if (!isNaN(value)) {
                precoServico += value;
                camposAdicionaisSelecionados[fieldName] = value;
            }
        });
        document.querySelectorAll(`.additional-field-input[data-service-id="${servico.id}"]`).forEach(input => {
            const fieldName = input.dataset.fieldName;
            const value = parseFloat(input.value);
            if (!isNaN(value)) {
                precoServico += value;
                camposAdicionaisSelecionados[fieldName] = value;
            }
        });

        servico.precoCalculado = precoServico;
        servico.camposAdicionaisSelecionados = camposAdicionaisSelecionados;
        total += precoServico;

        const li = document.createElement('li');
        let additionalHtml = '';
        for (const campo in camposAdicionaisSelecionados) {
            additionalHtml += `<br><small> - ${campo}: R$ ${camposAdicionaisSelecionados[campo].toFixed(2)}</small>`;
        }
        
        li.innerHTML = `
            <span><strong>${servico.nome}</strong></span>
            <span>R$ ${precoServico.toFixed(2)}</span>
            <button type="button" class="btn btn-danger btn-sm remove-service" data-key="${servico.id}">Remover</button>
            <div class="additional-info">${additionalHtml}</div>
        `;
        summaryServicosList.appendChild(li);
    });

    document.querySelectorAll('.remove-service').forEach(btn => {
        btn.addEventListener('click', (e) => removeService(e.target.dataset.key));
    });

    totalPriceElement.textContent = `Total: R$ ${total.toFixed(2)}`;
    orcamentoTotalInput.value = total.toFixed(2);
}


// ==========================================================================
// 4. LÓGICA DE FLUXO E AGENDAMENTO
// ==========================================================================

async function updateHorarios() {
    const dataSelecionada = dataInput.value;
    const diaDaSemana = new Date(dataSelecionada + 'T00:00:00').getDay();
    const dias = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
    const diaCorrente = dias[diaDaSemana];
    
    horaSelect.innerHTML = '<option value="">-- Selecione uma hora --</option>';
    horaSelect.disabled = true;
    btnFinalizar.disabled = true;

    if (dataSelecionada && configuracoes.horariosPorDia) {
        const configDia = configuracoes.horariosPorDia[diaCorrente];
        if (configDia && configDia.ativo) {
            await gerarHorarios(dataSelecionada, configDia.horarioInicio, configDia.horarioFim, configuracoes.duracaoServico);
        }
    }
}

async function gerarHorarios(data, inicio, fim, duracaoServico) {
    const agendamentosRef = ref(database, 'agendamentos');
    const snapshot = await get(agendamentosRef);
    const agendamentosExistentes = snapshot.exists() ? snapshot.val() : {};
    
    const horariosReservados = Object.values(agendamentosExistentes)
        .filter(agendamento => agendamento.data === formatarDataParaExibicao(new Date(data + 'T00:00:00')))
        .map(agendamento => agendamento.hora);
    
    const horariosDisponiveis = [];
    const [startHour, startMinute] = inicio.split(':').map(Number);
    const [endHour, endMinute] = fim.split(':').map(Number);
    
    let currentTime = new Date();
    currentTime.setHours(startHour, startMinute, 0, 0);

    const endTime = new Date();
    endTime.setHours(endHour, endMinute, 0, 0);
    endTime.setMinutes(endTime.getMinutes() - duracaoServico);

    while (currentTime <= endTime) {
        const horaFormatada = formatarHora(currentTime);
        if (data === new Date().toISOString().split('T')[0] && currentTime <= new Date()) {
            currentTime.setMinutes(currentTime.getMinutes() + duracaoServico);
            continue;
        }

        if (!horariosReservados.includes(horaFormatada)) {
            horariosDisponiveis.push(horaFormatada);
            const option = document.createElement('option');
            option.value = horaFormatada;
            option.textContent = horaFormatada;
            horaSelect.appendChild(option);
        }
        currentTime.setMinutes(currentTime.getMinutes() + duracaoServico);
    }
    horaSelect.disabled = false;
    btnFinalizar.disabled = horariosDisponiveis.length === 0;

    if (horariosDisponiveis.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "Nenhum horário disponível";
        horaSelect.appendChild(option);
        horaSelect.disabled = true;
    }
}

function formatarHora(date) {
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
}

function formatarDataParaExibicao(date) {
    const dia = String(date.getDate()).padStart(2, '0');
    const mes = String(date.getMonth() + 1).padStart(2, '0');
    const ano = date.getFullYear();
    return `${dia}/${mes}/${ano}`;
}

async function handleFormSubmit(e) {
    e.preventDefault();
    showLoading();

    const nome = document.getElementById('nome').value;
    const telefone = document.getElementById('telefone').value;
    const endereco = document.getElementById('endereco').value;
    const data = formatarDataParaExibicao(new Date(dataInput.value + 'T00:00:00'));
    const hora = horaSelect.value;
    const orcamentoTotal = parseFloat(orcamentoTotalInput.value);

    const novoAgendamento = {
        cliente: { nome, telefone, endereco },
        servicos: servicosSelecionados.map(s => ({
            id: s.id,
            nome: s.nome,
            precoBase: s.precoBase,
            precoCalculado: s.precoCalculado,
            camposAdicionaisSelecionados: s.camposAdicionaisSelecionados || {}
        })),
        data: data,
        hora: hora,
        orcamentoTotal: orcamentoTotal,
        status: 'Pendente' // Novo agendamento é sempre pendente
    };

    try {
        const agendamentosRef = ref(database, 'agendamentos');
        await push(agendamentosRef, novoAgendamento);
        hideLoading();
        showSuccess();
        setTimeout(() => {
            sendWhatsAppMessage(novoAgendamento);
            window.location.reload();
        }, 3000);
    } catch (error) {
        hideLoading();
        showError('Erro ao salvar o agendamento. Por favor, tente novamente.');
        console.error("Erro ao salvar agendamento:", error);
    }
}

function sendWhatsAppMessage(agendamento) {
    const whatsappNumber = configuracoes.whatsappNumber;
    if (!whatsappNumber) {
        console.error("Número do WhatsApp não configurado.");
        return;
    }

    let message = `Olá! Meu nome é ${agendamento.cliente.nome} e gostaria de confirmar o agendamento de um serviço.\n\n`;
    message += `*Detalhes do Agendamento:*\n`;
    message += `Data: ${agendamento.data}\n`;
    message += `Hora: ${agendamento.hora}\n`;
    message += `Endereço: ${agendamento.cliente.endereco}\n\n`;
    message += `*Serviços Solicitados:*\n`;
    agendamento.servicos.forEach(servico => {
        message += `- ${servico.nome} (R$ ${servico.precoCalculado.toFixed(2)})\n`;
        if (servico.camposAdicionaisSelecionados) {
            for (const campo in servico.camposAdicionaisSelecionados) {
                message += `  - ${campo}: R$ ${servico.camposAdicionaisSelecionados[campo].toFixed(2)}\n`;
            }
        }
    });
    message += `\n*Valor Total Estimado:* R$ ${agendamento.orcamentoTotal.toFixed(2)}\n\n`;
    message += `Por favor, confirme a disponibilidade. Obrigado!`;

    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

function showLoading() {
    loadingMessage.classList.remove('hidden');
    successMessage.classList.add('hidden');
    errorMessage.classList.add('hidden');
}

function hideLoading() {
    loadingMessage.classList.add('hidden');
}

function showSuccess() {
    successMessage.classList.remove('hidden');
}

function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
}
